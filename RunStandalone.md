# Running Standalone CUPiD (for existing CESM datasets)

CUPiD can be run either independently or via the CESM workflow. If you want to run CUPiD as part of a CESM case submission, we recommend looking at the Running CUPiD via CESM Workflow page. If you already have CESM data that you want to analyze, and don't plan on running CESM to generate a case, you have come to the right place!

## Setup
Install CUPiD's analysis and infrastructure environments per the [usual setup instructions](https://ncar.github.io/CUPiD/index.html#installing).

## Adjust CUPiD configuration
Update the [CUPiD configuration file](https://ncar.github.io/CUPiD/config.html) with values relevant to your case.

## Run Timeseries, if desired
Request resources-- eg, at NCAR, this may be useful: `qinteractive -l select=1:ncpus=12:mem=120GB`
`conda activate cupid-infrastructure`
`cupid-timeseries`

## Run Remapping, if desired
[Coming soon](https://github.com/NCAR/CUPiD/pull/251)
`conda activate cupid-infrastructure`
`cupid-remap`

## Running external packages, if desired
### Generate configuration files for external diagnostic packages based on CUPiD configuration file using helper scripts.
Some example commands that would be run from the `examples/key_metrics` directory may look like this:
`conda activate cupid-analysis`

Generate ADF config file:
`../../helper_scripts/generate_adf_config_file.py --cupid-config-loc .  --adf-template ../../externals/ADF/config_amwg_default_plots.yaml --out-file adf_config.yml`

Generate LDF config file:
`../../helper_scripts/generate_ldf_config_file.py --cupid-config-loc . --ldf-template ../../externals/LDF/config_clm_unstructured_plots.yaml --out-file ldf_config.yml`

Generate ILAMB config files:
`../../helper_scripts/generate_ilamb_config_files.py --cupid-config-loc . --run-type BGC --cupid-root ../../`

Note: Anything you change in the CUPiD configuration file will overwrite default external diagnostic package configuration file values (eg, from LDF). If values are not specified in the CUPiD config.yml, they will by default be set to the default external diagnostic package config file values.

### Running External Diagnostics
1) request resources-- eg, at NCAR, this may be useful: `qinteractive -l select=1:ncpus=12:mem=120GB -l walltime=08:00:00`
2) `conda activate cupid-analysis`
3) `module load nco
`
#### Run LDF
`../../externals/LDF/run_adf_diag ldf_config.yml`

#### Run ADF
`../../externals/ADF/run_adf_diag adf_config.yml`
Note: you can run CVDP by turning on `run_cvdp` in the ADF section of the config file, and then running ADF as described above.

#### Run ILAMB
Follow instructions that were printed when you generated the ILAMB config file, eg something like this:
`conda activate cupid-analysis`
`export ILAMB_ROOT=../../ilamb_aux`
`ilamb-run --config ilamb_nohoff_final_CLM_BGC.cfg --build_dir ILAMB_output/ --df_errs ${ILAMB_ROOT}/quantiles_Whittaker_cmip5v6.parquet --define_regions ${ILAMB_ROOT}/DATA/regions/LandRegions.nc ${ILAMB_ROOT}/DATA/regions/Whittaker.nc --regions global --model_setup model_setup.txt --filter .clm2.h0`
Note: If the `ILAMB_output` directory already exists in the example, remove it before re-running ILAMB.

Note: it is best to wait to run the next step until the webpages have been created for the above diagnostics. Eg, these files should exist if you want external diagnostic output to be linked properly to the final cupid webpages:
* `ADF_output/*/website/index.html`
* `LDF_output/*/website/index.html`
* `CVDP_output/*/output/index.html`
* `ILAMB_output/ ... *nc`

## Running CUPiD Diagnostics

CUPiD's main example for generating diagnostics is `examples/key-metrics`:

``` bash
$ conda activate cupid-infrastructure
$ cd examples/key_metrics
$ # machine-dependent: request multiple compute cores
$ cupid-diagnostics
$ cupid-webpage  # Will build HTML from Jupyter Book
```

## Viewing webpages
After the last step is finished, you can use Jupyter to view generated notebooks in `${CUPID_ROOT}/examples/key-metrics/computed_notebooks`
or you can view `${CUPID_ROOT}/examples/key-metrics/computed_notebooks/_build/html/index.html` in a web browser.

## Clean computed notebook directory
Furthermore, to clean the `computed_notebooks` folder which was generated by the `cupid-diagnostics` and `cupid-webpage` commands, you can run the following command:

``` bash
$ cupid-clean
```

This will clean the `computed_notebooks` folder which is at the location pointed to by the `run_dir` variable in the `config.yml` file.

### CUPiD Options

Most of CUPiD's configuration is done via the `config.yml` file, but there are a few command line options as well:

```bash
(cupid-infrastructure) $ cupid-diagnostics -h
Usage: cupid-diagnostics [OPTIONS] CONFIG_PATH

  Main engine to set up running all the notebooks.

Options:
  -s, --serial        Do not use LocalCluster objects
  -atm, --atmosphere  Run atmosphere component diagnostics
  -ocn, --ocean       Run ocean component diagnostics
  -lnd, --land        Run land component diagnostics
  -ice, --seaice      Run sea ice component diagnostics
  -glc, --landice     Run land ice component diagnostics
  -rof, --river-runoff Run river runoff component diagnostics
  --config_path       Path to the YAML configuration file containing specifications for notebooks (default config.yml)
  -h, --help          Show this message and exit.
```

#### Running in serial

By default, several of the example notebooks provided use a dask `LocalCluster` object to run in parallel.
However, the `--serial` option will pass a logical flag to each notebook that can be used to skip starting the cluster.

```py3
# Spin up cluster (if running in parallel)
client=None
if not serial:
  cluster = LocalCluster(**lc_kwargs)
  client = Client(cluster)

client
```

#### Specifying components

If no component flags are provided, all component diagnostics listed in `config.yml` will be executed by default. Multiple flags can be used together to select a group of components, for example: `cupid-diagnostics -ocn -ice`.
